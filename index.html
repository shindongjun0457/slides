<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Google Drive ìŠ¬ë¼ì´ë“œì‡¼</title>
  <style>
    :root{
      --bg: #000;       /* ë°°ê²½(ë ˆí„°ë°•ìŠ¤) */
      --fg: #fff;       /* ê¸€ììƒ‰ */
      --muted:#bbb;
      --accent:#7cc;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
    }
    .app{height:100%; display:grid; grid-template-rows:auto 1fr auto}
    header, footer{display:flex; align-items:center; gap:.75rem; padding:.6rem .9rem}
    header{justify-content:space-between; background:rgba(255,255,255,.06);}
    footer{justify-content:center; background:rgba(255,255,255,.04);}

    .btn{appearance:none; border:1px solid rgba(255,255,255,.25); background:transparent; color:var(--fg);
      padding:.5rem .8rem; border-radius:999px; cursor:pointer; font-weight:600}
    .btn:hover{border-color:var(--fg)}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .icon-btn{display:inline-flex; align-items:center; gap:.4rem}

    .status{font-size:.9rem; color:var(--muted)}
    .spacer{flex:1}

    /* ë·°ì–´: ì‹¤ì œ ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€ + ê²€ì€ ë°°ê²½ ë ˆí„°ë°•ìŠ¤ */
    .viewer{
      position:relative; height:100%; width:100%; display:grid;
      place-items:center; background:var(--bg); overflow:hidden;
    }
    .viewer img{max-width:100%; max-height:100%; object-fit:contain; background:var(--bg)}

    /* dots ì¸ë””ì¼€ì´í„° (í•„ìš” ì‹œ) */
    .dots{display:flex; gap:.4rem; flex-wrap:wrap; justify-content:center; padding:.4rem}
    .dot{width:.55rem; height:.55rem; border-radius:50%; border:1px solid rgba(255,255,255,.5); opacity:.6; cursor:pointer}
    .dot.active{background:var(--fg); opacity:1}

    .hidden{display:none}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div style="display:flex; align-items:center; gap:.6rem">
        <strong>Drive ìŠ¬ë¼ì´ë“œì‡¼</strong>
        <span class="status" id="status">ë¡œê·¸ì¸ í•„ìš”</span>
      </div>
      <div class="spacer"></div>
      <!-- ë¡œê·¸ì¸ / ë¡œê·¸ì•„ì›ƒ -->
      <button class="btn" id="loginBtn">Google ë¡œê·¸ì¸</button>
      <button class="btn hidden" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
    </header>

    <main class="viewer">
      <img id="slide" alt="ì‚¬ì§„" />
    </main>

    <footer>
      <button class="btn icon-btn" id="prevBtn" title="ì´ì „(â†)">â—€ ì´ì „</button>
      <button class="btn icon-btn" id="playPauseBtn" title="ì¼ì‹œì •ì§€/ì¬ìƒ">â¸ ì¼ì‹œì •ì§€</button>
      <button class="btn icon-btn" id="nextBtn" title="ë‹¤ìŒ(â†’)">ë‹¤ìŒ â–¶</button>
      <button class="btn icon-btn" id="reloadBtn" title="Driveì—ì„œ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <span class="spacer"></span>
      <label class="status">ì „í™˜ ê°„ê²©
        <select id="intervalSelect">
          <option value="3000">3ì´ˆ</option>
          <option value="5000" selected>5ì´ˆ</option>
          <option value="8000">8ì´ˆ</option>
          <option value="10000">10ì´ˆ</option>
        </select>
      </label>
    </footer>
  </div>

  <!-- Google Identity Services (OAuth 2.0 í† í° ì „ìš©) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    /*** ğŸ”§ ì„¤ì •ê°’: ì•„ë˜ 3ê°€ì§€ë§Œ êµì²´í•˜ë©´ ì‘ë™í•©ë‹ˆë‹¤ ***/
    const GOOGLE_CLIENT_ID = "195530113287-9v9le5k38vjbumgl839pkopn04hv747o.apps.googleusercontent.com"; // GCP OAuth í´ë¼ì´ì–¸íŠ¸ ID
    const DRIVE_FOLDER_ID  = "1pvgxYx7jSiuCYZAX_UXXiBxTMffRV_at";                          // ëŒ€ìƒ í´ë” ID
    const ALLOWED_EMAILS   = ["djshin0457@gmail.com",
    "djcom@ohyun.ms.kr",
    "m23djcom@onedu.jje.go.kr"
      // ì´ ë°°ì—´ì— í—ˆìš©í•  êµ¬ê¸€ ê³„ì • ì´ë©”ì¼ì„ ë„£ìœ¼ë©´ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê²€ì¦ì„ í•©ë‹ˆë‹¤.
      // ì˜ˆ: "you@example.com", "principal@school.kr"
    ];

    /*** ìƒìˆ˜ & ìƒíƒœ ***/
    const DRIVE_SCOPE = "https://www.googleapis.com/auth/drive.readonly";
    const API_BASE = "https://www.googleapis.com/drive/v3";

    let tokenClient = null;     // GIS í† í° í´ë¼ì´ì–¸íŠ¸
    let accessToken = null;     // ì•¡ì„¸ìŠ¤ í† í°
    let userEmail   = null;     // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì´ë©”ì¼ (id_token ë””ì½”ë”©)

    let files = [];             // [{id,name,mimeType,modifiedTime}]
    let index = 0;              // í˜„ì¬ ì¸ë±ìŠ¤
    let timer = null;           // ìŠ¬ë¼ì´ë“œì‡¼ íƒ€ì´ë¨¸
    let intervalMs = 5000;      // ê¸°ë³¸ 5ì´ˆ
    let playing = true;         // ì¬ìƒ/ì¼ì‹œì •ì§€ ìƒíƒœ

    /*** DOM ***/
    const statusEl = document.getElementById('status');
    const slideEl = document.getElementById('slide');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const reloadBtn = document.getElementById('reloadBtn');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const intervalSelect = document.getElementById('intervalSelect');

    /*** ìœ í‹¸: ê°„ë‹¨í•œ í† ìŠ¤íŠ¸ ***/
    function toast(msg){
      statusEl.textContent = msg;
    }

    /*** OAuth ë¡œê·¸ì¸ ***/
    window.onload = () => {
      // OAuth í† í° í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: DRIVE_SCOPE + ' email profile openid',
        callback: (resp) => {
          if(resp && resp.access_token){
            accessToken = resp.access_token;
            // ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œì„ ìœ„í•´ ID í† í°ë„ ìš”ì²­(íŒ: tokenClientëŠ” id_token ì§ì ‘ ì œê³µ X â†’ ë³„ë„ fetch í•„ìš”)
            // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ peopleinfo ëŒ€ì‹  tokeninfoë¡œ ì´ë©”ì¼ í™•ì¸
            fetch(`https://www.googleapis.com/oauth2/v3/userinfo`, {
              headers: { Authorization: `Bearer ${accessToken}` }
            }).then(r=>r.json()).then(info => {
              userEmail = info.email;
              // í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ê²€ì‚¬
              if(ALLOWED_EMAILS.length > 0 && !ALLOWED_EMAILS.includes(userEmail)){
                toast(`í—ˆìš©ë˜ì§€ ì•Šì€ ê³„ì •ì…ë‹ˆë‹¤: ${userEmail}`);
                logoutUI();
                return;
              }
              loginUI(info);
              // ì²« ë¡œë“œ
              loadAllImages().then(() => startSlideshow());
            }).catch(err => {
              console.error(err); toast('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
            });
          }else{
            toast('ë¡œê·¸ì¸ ì‹¤íŒ¨');
          }
        }
      });

      // ë²„íŠ¼ ì´ë²¤íŠ¸
      loginBtn.onclick = requestAccessToken;
      logoutBtn.onclick = doLogout;
      prevBtn.onclick = prev;
      nextBtn.onclick = next;
      reloadBtn.onclick = async () => {
        const keep = index; // í˜„ì¬ ì¸ë±ìŠ¤ ê¸°ì–µ
        await loadAllImages();
        // ê°€ëŠ¥í•˜ë©´ ê°™ì€ íŒŒì¼ë¡œ ê³„ì†, ì—†ìœ¼ë©´ ê°€ì¥ ê°€ê¹Œìš´ ì¸ë±ìŠ¤ë¡œ
        index = Math.min(keep, Math.max(0, files.length - 1));
        show(index);
        if(playing) restartTimer();
        toast('Driveì—ì„œ ìµœì‹  ëª©ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
      }
      playPauseBtn.onclick = togglePlay;
      intervalSelect.onchange = () => {
        intervalMs = parseInt(intervalSelect.value,10);
        if(playing) restartTimer();
      }

      // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
      window.addEventListener('keydown', (e)=>{
        if(e.key === 'ArrowLeft') prev();
        if(e.key === 'ArrowRight') next();
        if(e.key === ' ') { e.preventDefault(); togglePlay(); }
        if(e.key.toLowerCase() === 'r') reloadBtn.click();
      });
    }

    function requestAccessToken(){
      tokenClient.requestAccessToken({ prompt: 'consent' });
    }

    function loginUI(info){
      loginBtn.classList.add('hidden');
      logoutBtn.classList.remove('hidden');
      statusEl.textContent = `${info.email} ë¡œê·¸ì¸ë¨`;
      prevBtn.disabled = nextBtn.disabled = reloadBtn.disabled = false;
      playPauseBtn.disabled = false;
    }
    function logoutUI(){
      loginBtn.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      statusEl.textContent = 'ë¡œê·¸ì¸ í•„ìš”';
      prevBtn.disabled = nextBtn.disabled = reloadBtn.disabled = true;
      playPauseBtn.disabled = true;
      stopSlideshow();
      files = []; index = 0; slideEl.removeAttribute('src');
    }

    function doLogout(){
      accessToken = null; userEmail = null;
      // GISëŠ” ëª…ì‹œì  ì„¸ì…˜ ì¢…ë£Œ APIê°€ ì—†ìŠµë‹ˆë‹¤. í† í° ë§Œë£Œë¥¼ ê¸°ë‹¤ë¦¬ê±°ë‚˜ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.
      // UX ì°¨ì›ì—ì„œ ìƒíƒœë§Œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
      logoutUI();
      toast('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    /*** Driveì—ì„œ ì´ë¯¸ì§€ ëª¨ë‘ ê°€ì ¸ì˜¤ê¸°(í˜ì´ì§€ë„¤ì´ì…˜ í¬í•¨) ***/
    async function loadAllImages(){
      if(!accessToken) throw new Error('accessToken ì—†ìŒ');
      files = [];
      let pageToken = undefined;
      const q = encodeURIComponent(`'${DRIVE_FOLDER_ID}' in parents and mimeType contains 'image/' and trashed = false`);
      const fields = encodeURIComponent('nextPageToken, files(id,name,mimeType,modifiedTime)');
      do{
        const url = `${API_BASE}/files?q=${q}&fields=${fields}&orderBy=modifiedTime&pageSize=1000&supportsAllDrives=true&includeItemsFromAllDrives=true${pageToken?`&pageToken=${pageToken}`:''}`;
        const res = await fetch(url, { headers:{ Authorization: `Bearer ${accessToken}` } });
        if(!res.ok){
          const t = await res.text();
          console.error('Drive list error', t);
          throw new Error('Drive ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
        }
        const data = await res.json();
        if(Array.isArray(data.files)) files.push(...data.files);
        pageToken = data.nextPageToken;
      }while(pageToken);

      if(files.length === 0){
        toast('í´ë”ì— ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤');
      }else{
        toast(`${files.length}ì¥ ë¡œë“œ ì™„ë£Œ`);
      }
      index = Math.min(index, Math.max(0, files.length - 1));
      show(index);
    }

    /*** íŒŒì¼ IDë¡œ Blobì„ ë°›ì•„ <img>ì— í‘œì‹œ ***/
    async function show(i){
      if(files.length === 0) { slideEl.removeAttribute('src'); return; }
      index = (i + files.length) % files.length;
      const file = files[index];
      try{
        const url = `${API_BASE}/files/${file.id}?alt=media`;
        const res = await fetch(url, { headers:{ Authorization: `Bearer ${accessToken}` } });
        if(!res.ok){
          throw new Error('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
        }
        const blob = await res.blob();
        const objUrl = URL.createObjectURL(blob);
        slideEl.src = objUrl;
        slideEl.onload = () => {
          // ì´ì „ blob í•´ì œ(ë©”ëª¨ë¦¬ ê´€ë¦¬)
          setTimeout(()=> URL.revokeObjectURL(objUrl), 1000);
        }
      }catch(err){
        console.error(err);
        toast('ì´ë¯¸ì§€ í‘œì‹œ ì¤‘ ì˜¤ë¥˜');
      }
    }

    /*** ìŠ¬ë¼ì´ë“œì‡¼ ì»¨íŠ¸ë¡¤ ***/
    function next(){ if(files.length){ show(index+1); } }
    function prev(){ if(files.length){ show(index-1); } }

    function startSlideshow(){
      playing = true;
      playPauseBtn.textContent = 'â¸ ì¼ì‹œì •ì§€';
      restartTimer();
    }
    function stopSlideshow(){
      playing = false;
      playPauseBtn.textContent = 'â–¶ ì¬ìƒ';
      if(timer) { clearInterval(timer); timer = null; }
    }
    function restartTimer(){
      if(timer) clearInterval(timer);
      timer = setInterval(()=>{ next(); }, intervalMs);
    }
    function togglePlay(){
      if(playing) stopSlideshow(); else startSlideshow();
    }
  </script>

  <!-- ğŸ“ ì‚¬ìš© ë°©ë²•
    1) Google Cloud ì½˜ì†”ì—ì„œ OAuth í´ë¼ì´ì–¸íŠ¸ ID(Web)ë¥¼ ë°œê¸‰í•˜ì—¬ GOOGLE_CLIENT_IDì— ë„£ìŠµë‹ˆë‹¤.
    2) ìŠ¬ë¼ì´ë“œ ëŒ€ìƒì´ ë  êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” IDë¥¼ DRIVE_FOLDER_IDì— ë„£ìŠµë‹ˆë‹¤.
       - í´ë” URL ì˜ˆ: https://drive.google.com/drive/folders/XXXX â†’ ì´ë•Œ XXXXê°€ í´ë” ID
    3) ALLOWED_EMAILSì— í—ˆìš©í•  êµ¬ê¸€ ê³„ì •ì„ ì¶”ê°€í•˜ë©´ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë¡œ ì œí•œë©ë‹ˆë‹¤(ì„ íƒ).
    4) ë°°í¬: Netlify/Cloudflare Pages ë“±ì— ì—…ë¡œë“œ í›„, OAuth ìŠ¹ì¸ëœ ë¦¬ë””ë ‰íŠ¸/í—ˆìš© ë„ë©”ì¸ì— í•´ë‹¹ URLì„ ë“±ë¡í•˜ì„¸ìš”.
    5) í´ë”ëŠ” ë¹„ê³µê°œì—¬ë„ ë©ë‹ˆë‹¤. ë‹¨, ë¡œê·¸ì¸í•œ ê³„ì •ì´ ê·¸ í´ë”(ë˜ëŠ” ìƒìœ„ ê³µìœ ë“œë¼ì´ë¸Œ)ì— ìµœì†Œ "ë³´ê¸°" ê¶Œí•œì„ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤.
       ì—¬ëŸ¬ ì‚¬ëŒì´ ë³¼ ê²½ìš°: (A) ê° ì‹œì²­ìì˜ êµ¬ê¸€ ê³„ì •ì„ í´ë”ì— ë·°ì–´ë¡œ ì´ˆëŒ€í•˜ê±°ë‚˜, (B) ë°±ì—”ë“œ í”„ë¡ì‹œ+ì„œë¹„ìŠ¤ ê³„ì • êµ¬ì¡°ë¡œ êµ¬í˜„í•˜ì„¸ìš”.
  -->
</body>
</html>
