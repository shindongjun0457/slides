<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Google Drive ìŠ¬ë¼ì´ë“œì‡¼</title>
  <style>
    :root{
      --bg: #000;
      --fg: #fff;
      --muted:#bbb;
      --accent:#7cc;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
    }
    .app{height:100%; display:grid; grid-template-rows:auto 1fr auto}
    header, footer{display:flex; align-items:center; gap:.75rem; padding:.6rem .9rem; transition:all 0.6s ease;}
    header{justify-content:space-between; background:rgba(255,255,255,.06);}
    footer{justify-content:center; background:rgba(255,255,255,.04);}
    header.hidden-ui, footer.hidden-ui{opacity:0; pointer-events:none;}
    header.hidden-ui{transform:translateY(-20px);}
    footer.hidden-ui{transform:translateY(20px);}

    .btn{appearance:none; border:1px solid rgba(255,255,255,.25); background:transparent; color:var(--fg);
      padding:.5rem .8rem; border-radius:999px; cursor:pointer; font-weight:600}
    .btn:hover{border-color:var(--fg)}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .icon-btn{display:inline-flex; align-items:center; gap:.4rem}

    .status{font-size:.9rem; color:var(--muted)}
    .spacer{flex:1}

    .viewer{
      position:relative; height:100%; width:100%; display:grid;
      place-items:center; background:var(--bg); overflow:hidden;
    }
    .viewer img{
      max-width:100%; max-height:100%; object-fit:contain; background:var(--bg);
      opacity:0; transition:opacity 1s ease;
    }
    .viewer img.visible{opacity:1;}

    .counter{
      position:absolute; bottom:10px; right:20px;
      background:rgba(0,0,0,0.5); padding:4px 8px; border-radius:6px; font-size:.9rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div style="display:flex; align-items:center; gap:.6rem">
        <strong>Drive ìŠ¬ë¼ì´ë“œì‡¼</strong>
        <span class="status" id="status">ë¡œê·¸ì¸ í•„ìš”</span>
      </div>
      <div class="spacer"></div>
      <button class="btn" id="loginBtn">Google ë¡œê·¸ì¸</button>
      <button class="btn hidden" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
    </header>

    <main class="viewer">
      <img id="slide" alt="ì‚¬ì§„" />
      <div class="counter" id="counter">0 / 0</div>
    </main>

    <footer>
      <button class="btn icon-btn" id="prevBtn">â—€ ì´ì „</button>
      <button class="btn icon-btn" id="playPauseBtn">â¸ ì¼ì‹œì •ì§€</button>
      <button class="btn icon-btn" id="nextBtn">ë‹¤ìŒ â–¶</button>
      <button class="btn icon-btn" id="reloadBtn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <span class="spacer"></span>
      <label class="status">ì „í™˜ ê°„ê²©
        <select id="intervalSelect">
          <option value="5000">5ì´ˆ</option>
          <option value="10000" selected>10ì´ˆ</option>
          <option value="15000">15ì´ˆ</option>
          <option value="20000">20ì´ˆ</option>
          <option value="25000">25ì´ˆ</option>
          <option value="30000">30ì´ˆ</option>
        </select>
      </label>
    </footer>
  </div>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    /*** ğŸ”§ ì‚¬ìš©ì ì„¤ì • ***/
    const GOOGLE_CLIENT_ID = "195530113287-9v9le5k38vjbumgl839pkopn04hv747o.apps.googleusercontent.com"; // GCP OAuth í´ë¼ì´ì–¸íŠ¸ ID
    const DRIVE_FOLDER_ID  = "1pvgxYx7jSiuCYZAX_UXXiBxTMffRV_at";                          // ëŒ€ìƒ í´ë” ID
    const ALLOWED_EMAILS   = [
      "djshin0457@gmail.com",
      "djcom@ohyun.ms.kr",
      "m23djcom@onedu.jje.go.kr"
    ]; // í—ˆìš© ì´ë©”ì¼ ëª©ë¡

    const DRIVE_SCOPE = "https://www.googleapis.com/auth/drive.readonly";
    const API_BASE = "https://www.googleapis.com/drive/v3";

    let tokenClient=null, accessToken=null, userEmail=null;
    let files=[], index=0, timer=null, intervalMs=10000, playing=true;

    const statusEl=document.getElementById('status');
    const slideEl=document.getElementById('slide');
    const loginBtn=document.getElementById('loginBtn');
    const logoutBtn=document.getElementById('logoutBtn');
    const prevBtn=document.getElementById('prevBtn');
    const nextBtn=document.getElementById('nextBtn');
    const reloadBtn=document.getElementById('reloadBtn');
    const playPauseBtn=document.getElementById('playPauseBtn');
    const intervalSelect=document.getElementById('intervalSelect');
    const counterEl=document.getElementById('counter');

    function toast(msg){statusEl.textContent=msg;}

    window.onload=()=>{
      tokenClient=google.accounts.oauth2.initTokenClient({
        client_id:GOOGLE_CLIENT_ID,
        scope:DRIVE_SCOPE+' email profile openid',
        callback:(resp)=>{
          if(resp && resp.access_token){
            accessToken=resp.access_token;
            fetch(`https://www.googleapis.com/oauth2/v3/userinfo`,{headers:{Authorization:`Bearer ${accessToken}`}})
            .then(r=>r.json()).then(info=>{
              userEmail=info.email;
              if(ALLOWED_EMAILS.length>0 && !ALLOWED_EMAILS.includes(userEmail)){
                toast(`í—ˆìš©ë˜ì§€ ì•Šì€ ê³„ì •: ${userEmail}`);
                logoutUI(); return;
              }
              loginUI(info);
              loadAllImages().then(()=>startSlideshow());
            }).catch(()=>toast('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨'));
          }else toast('ë¡œê·¸ì¸ ì‹¤íŒ¨');
        }
      });

      loginBtn.onclick=requestAccessToken;
      logoutBtn.onclick=doLogout;
      prevBtn.onclick=prev;
      nextBtn.onclick=next;
      reloadBtn.onclick=async()=>{
        const keep=index; await loadAllImages();
        index=Math.min(keep,Math.max(0,files.length-1));
        show(index); if(playing)restartTimer();
        toast('Driveì—ì„œ ìµœì‹  ëª©ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
      };
      playPauseBtn.onclick=togglePlay;
      intervalSelect.onchange=()=>{
        intervalMs=parseInt(intervalSelect.value,10);
        if(playing)restartTimer();
      };

      let uiHidden=false;
      window.addEventListener('keydown',(e)=>{
        if(e.key==='ArrowLeft')prev();
        if(e.key==='ArrowRight')next();
        if(e.key===' '){e.preventDefault();togglePlay();}
        if(e.key.toLowerCase()==='r')reloadBtn.click();
        if(e.key.toLowerCase()==='h'){
          uiHidden=!uiHidden;
          document.querySelector('header').classList.toggle('hidden-ui',uiHidden);
          document.querySelector('footer').classList.toggle('hidden-ui',uiHidden);
        }
        if(e.key.toLowerCase()==='f') toggleFullScreen();
      });
    }

    function requestAccessToken(){tokenClient.requestAccessToken({prompt:'consent'});}
    function loginUI(info){
      loginBtn.classList.add('hidden');
      logoutBtn.classList.remove('hidden');
      statusEl.textContent=`${info.email} ë¡œê·¸ì¸ë¨`;
    }
    function logoutUI(){
      loginBtn.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      statusEl.textContent='ë¡œê·¸ì¸ í•„ìš”';
      stopSlideshow(); files=[]; index=0; slideEl.removeAttribute('src');
    }
    function doLogout(){accessToken=null; userEmail=null; logoutUI(); toast('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤');}

    async function loadAllImages(){
      if(!accessToken) throw new Error('accessToken ì—†ìŒ');
      files=[]; let pageToken;
      const q=encodeURIComponent(`'${DRIVE_FOLDER_ID}' in parents and mimeType contains 'image/' and trashed = false`);
      const fields=encodeURIComponent('nextPageToken, files(id,name,mimeType,modifiedTime)');
      do{
        const url=`${API_BASE}/files?q=${q}&fields=${fields}&orderBy=modifiedTime&pageSize=1000${pageToken?`&pageToken=${pageToken}`:''}`;
        const res=await fetch(url,{headers:{Authorization:`Bearer ${accessToken}`}});
        const data=await res.json();
        if(Array.isArray(data.files)) files.push(...data.files);
        pageToken=data.nextPageToken;
      }while(pageToken);
      toast(`${files.length}ì¥ ë¡œë“œ ì™„ë£Œ`);
      index=Math.min(index,Math.max(0,files.length-1));
      show(index);
    }

    async function show(i){
      if(files.length===0){slideEl.removeAttribute('src');counterEl.textContent='0 / 0';return;}
      index=(i+files.length)%files.length;
      const file=files[index];
      const url=`${API_BASE}/files/${file.id}?alt=media`;
      const res=await fetch(url,{headers:{Authorization:`Bearer ${accessToken}`}});
      const blob=await res.blob();
      const objUrl=URL.createObjectURL(blob);
      slideEl.classList.remove('visible');
      slideEl.src=objUrl;
      slideEl.onload=()=>{
        slideEl.classList.add('visible');
        setTimeout(()=>URL.revokeObjectURL(objUrl),1000);
      };
      counterEl.textContent=`${index+1} / ${files.length}`;
    }

    function next(){if(files.length){show(index+1);}}
    function prev(){if(files.length){show(index-1);}}

    function startSlideshow(){playing=true;playPauseBtn.textContent='â¸ ì¼ì‹œì •ì§€';restartTimer();}
    function stopSlideshow(){playing=false;playPauseBtn.textContent='â–¶ ì¬ìƒ';if(timer){clearInterval(timer);timer=null;}}
    function restartTimer(){if(timer)clearInterval(timer);timer=setInterval(()=>{next();},intervalMs);}
    function togglePlay(){if(playing)stopSlideshow();else startSlideshow();}

    function toggleFullScreen(){
      if(!document.fullscreenElement){document.documentElement.requestFullscreen();}
      else if(document.exitFullscreen){document.exitFullscreen();}
    }
  </script>
</body>
</html>
